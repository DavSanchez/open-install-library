# Visit our schema definition for additional information on this file format
# https://github.com/newrelic/open-install-library/blob/main/docs/recipe-spec/recipe-spec.md#schema-definition

name: infrastructure-agent-installer
displayName: Infrastructure Agent
description: New Relic install recipe for the Infrastructure agent
repository: https://github.com/newrelic/infrastructure-agent

installTargets:
  - type: host
    os: darwin

keywords:
  - Infrastructure
  - Agent
  - Darwin
  - Mac
  - MacOS

processMatch: []

validationNrql: "SELECT count(*) from SystemSample where hostname like '{{.HOSTNAME}}' FACET entityGuid SINCE 10 minutes ago"

preInstall:
  info: |2
      Note: EXPERIMENTAL RECIPE
      This installation makes use of homebrew to install the infra agent

install:
  version: "3"
  silent: true

  tasks:
    default:
      cmds:
        - task: assert_pre_req
        - task: setup_license
        - task: install_infra
        - task: start
        - task: assert_agent_started

    assert_pre_req:
      cmds:
        - |
          # FIXME check we're *not* running as root
          IS_HOMEBREW_INSTALLED=$(which brew | wc -l)
          if [ $IS_HOMEBREW_INSTALLED -eq 0 ] ; then
            echo "homebrew is required to run the newrelic install. Please install homebrew and re-run the installation." >> /dev/stderr
            exit 10
          fi
          brew update
 
    setup_license:
      cmds:
        - |
          if [ -f /etc/newrelic-infra.yml ]; then
            sudo sed -i'.bak' -e '/^staging/d' /etc/newrelic-infra.yml

            sudo sed -i'.bak' -e "s/^\(license_key: \).*/\1{{.NEW_RELIC_LICENSE_KEY}}/" /etc/newrelic-infra.yml
            sudo sed -i'.bak' -e 's/^\(enable_process_metrics: \).*/\1true/' /etc/newrelic-infra.yml
          else
            # Because we need to use sudo on mac, we have to start a proper bash shell to avoid
            # problems with output redirection
            sudo touch /etc/newrelic-infra.yml
            sudo bash -c "echo \"license_key: {{.NEW_RELIC_LICENSE_KEY}}\" >> /etc/newrelic-infra.yml"
            sudo bash -c "echo 'enable_process_metrics: true' >> /etc/newrelic-infra.yml"
          fi
        - |
          if [ $(echo {{.NEW_RELIC_REGION}} | grep -i staging | wc -l) -gt 0 ]; then
            sudo bash -c "echo 'staging: true' >> /etc/newrelic-infra.yml"
          fi

    install_infra:
      cmds:
        - |
          IS_INFRA_AGENT_INSTALLED=$(brew list newrelic-infra-agent 2>/dev/null | wc -l)
          if [ $IS_INFRA_AGENT_INSTALLED -gt 0 ] ; then
            echo "newrelic-infra-agent already installed"
          else
            echo "Installing newrelic-infra-agent..."
            brew install newrelic-infra-agent
          fi
      silent: false

    start:
      cmds:
        - |
          sudo newrelic-infra-agent &
          # if [ {{.IS_SYSTEMCTL}} -gt 0 ]; then
          #   sudo systemctl restart newrelic-infra
          # else 
          #   if [ {{.IS_INITCTL}} -gt 0 ]; then
          #     sudo initctl restart newrelic-infra
          #   else
          #     sudo /etc/init.d/newrelic-infra restart
          #   fi
          # fi
      # vars:
      #   IS_SYSTEMCTL:
      #     sh: command -v systemctl | wc -l
      #   IS_INITCTL:
      #     sh: command -v initctl | wc -l

    assert_agent_started:
      cmds:
        - |
          # Ensure agent has enough time to start
          sleep 10
          IS_INFRA_INSTALLED=$(sudo ps -ef | grep [n]ewrelic-infra-agent | wc -l)
          if [ $IS_INFRA_INSTALLED -eq 0 ] ; then
            echo "The infrastructure agent has not started after installing. Please try again later, or see our documentation for installing manually https://docs.newrelic.com/docs/using-new-relic/cross-product-functions/install-configure/install-new-relic" >> /dev/stderr
            exit 31
          fi

postInstall:
  info: |2
      ⚙️  The Infrastructure Agent configuration file can be found in /etc/newrelic-infra.yml
      Edit this file to make changes or configure advanced features for the agent. See the docs for options:
      https://docs.newrelic.com/docs/infrastructure/install-infrastructure-agent/configuration/infrastructure-agent-configuration-settings
      
      Note: Process monitoring has been enabled by default - all other config options are left to the user.
