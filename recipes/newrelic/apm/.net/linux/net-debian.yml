# Visit our schema definition for additional information on this file format
# https://github.com/newrelic/open-install-library/blob/main/docs/recipe-spec/recipe-spec.md#schema-definition

name: dotnet-agent-installer
displayName: .NET Agent Installer
description:  New Relic install recipe for .NET application on Linux
repository: https://github.com/newrelic/newrelic-dotnet-agent

installTargets:
  - type: host
    os: linux
    platform: debian

keywords:
  - Apm
  - .NET
  - dotnet
  - aspnet
  - core

validationNrql: "SELECT count(*) from Transaction WHERE host like '{{.HOSTNAME}}%' facet entityGuid since 10 minutes ago"

install:

  version: "3"
  silent: true

  tasks:
    default:
      cmds:
        - task: assert_pre_req
        - task: remove_any_previous
        - task: install
        - task: configure

    assert_pre_req:
      cmds:
        - |
          results=$(dpkg-query -W -f='${Status}\n' dotnet-runtime-*)
          if [ $? -ne 0 ]; then
            # Did not find the dotnet-runtime package, don't install the agent
            exit 1
          fi

    remove_any_previous:
      cmds:
        - sudo apt-get purge -y newrelic-netcore20-agent || exit 0
        - sudo rm /etc/profile.d/newrelic-netcore20-agent-path.sh || exit 0

    install:
      cmds:
        - echo 'deb http://apt.newrelic.com/debian/ newrelic non-free' | sudo tee /etc/apt/sources.list.d/newrelic.list
        - curl -Ls https://download.newrelic.com/548C16BF.gpg | sudo apt-key add -
        - sudo apt-get update
        - sudo apt-get install newrelic-netcore20-agent
        - echo "New Relic .NET agent installed"

    configure:
      cmds:
        - |
          echo "Setup startup environment variables"
          echo 'export NEW_RELIC_LICENSE_KEY={{.NEW_RELIC_LICENSE_KEY}}' | sudo tee -a /etc/profile.d/newrelic-netcore20-agent-path.sh
          
          echo "Setup session environment variables for child processes"
          export NEW_RELIC_LICENSE_KEY={{.NEW_RELIC_LICENSE_KEY}}
          export CORECLR_NEWRELIC_HOME=/usr/local/newrelic-netcore20-agent
          export CORECLR_ENABLE_PROFILING=1
          export CORECLR_PROFILER={36032161-FFC0-4B61-B559-F6C5D41BAE5A}
          export CORECLR_PROFILER_PATH=$CORECLR_NEWRELIC_HOME/libNewRelicProfiler.so



