# Visit our schema definition for additional information on this file format
# https://github.com/newrelic/open-install-library/blob/main/docs/recipe-spec/recipe-spec.md#schema-definition

name: dotnet-agent-installer
displayName: .NET Agent Installer
description:  New Relic install recipe for .NET application on Linux
repository: https://github.com/newrelic/newrelic-dotnet-agent

installTargets:
  - type: host
    os: linux
    platform: amazon
    platformVersion: 2
  - type: host
    os: linux
    platform: centos
  - type: host
    os: linux
    platform: redhat

keywords:
  - Apm
  - .NET
  - dotnet
  - aspnet
  - core

validationNrql: "SELECT count(*) from Transaction WHERE host like '{{.HOSTNAME}}%' facet entityGuid since 10 minutes ago"

install:

  version: "3"
  silent: false

  tasks:
    default:
      cmds:
        - task: assert_pre_req
        - task: remove_any_previous
        - task: install
        - task: configure

    assert_pre_req:
      cmds:
        - |
          results=$(yum list installed dotnet-runtime-*)
          if [ $? -ne 0 ]; then
            # Did not find the dotnet-runtime package, don't install the agent
            exit 1
          fi

    remove_any_previous:
      cmds:
        - sudo yum remove newrelic-netcore20-agent -y
        - |
          AGENTPROFILE=/etc/profile.d/newrelic-netcore20-agent-path.sh
          if test -f "$AGENTPROFILE"; then
              sudo rm $AGENTPROFILE
          fi
          

    install:
      cmds:
        - |
          if [ ! "$(rpm -qa | grep newrelic-repo)" ]; then
            sudo rpm -Uvh http://yum.newrelic.com/pub/newrelic/el5/x86_64/newrelic-repo-5-3.noarch.rpm
            cat <<- EOL | sudo tee "/etc/yum.repos.d/newrelic-netcore20-agent.repo"
            [newrelic-netcore20-agent-repo]
            name=New Relic .NET Core packages for Enterprise Linux
            baseurl=http://yum.newrelic.com/pub/newrelic/el7/\$basearch
            enabled=1
            gpgcheck=1
            gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-NewRelic
          EOL
          fi
        - sudo yum install newrelic-netcore20-agent -y
        - echo "New Relic .NET agent installed"

    configure:
      cmds:
        - |
          echo "Setup startup environment variables"
          echo 'export NEW_RELIC_LICENSE_KEY={{.NEW_RELIC_LICENSE_KEY}}' | sudo tee -a /etc/profile.d/newrelic-netcore20-agent-path.sh
          
          echo "Setup session environment variables for child processes"
          export NEW_RELIC_LICENSE_KEY={{.NEW_RELIC_LICENSE_KEY}}
          export CORECLR_NEWRELIC_HOME=/usr/local/newrelic-netcore20-agent
          export CORECLR_ENABLE_PROFILING=1
          export CORECLR_PROFILER={36032161-FFC0-4B61-B559-F6C5D41BAE5A}
          export CORECLR_PROFILER_PATH=$CORECLR_NEWRELIC_HOME/libNewRelicProfiler.so

