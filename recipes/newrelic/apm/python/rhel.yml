# Visit our schema definition for additional information on this file format
# https://github.com/newrelic/open-install-library/blob/main/docs/recipe-spec/recipe-spec.md#schema-definition

name: python-agent-installer
displayName: Python Agent Installer
description: New Relic install recipe for instrumenting Python applications
repository: https://github.com/newrelic/newrelic-python-agent

installTargets:
  - type: application
    os: linux
    platform: amazon
    platformVersion: '2'
  - type: application
    os: linux
    platform: 'centos'
  - type: application
    os: linux
    platform: 'redhat'

keywords:
  - python

processMatch:
  - python

validationNrql: "SELECT count(*) from Transaction WHERE host like '{{.HOSTNAME}}%' facet entityGuid since 10 minutes ago"

successLinkConfig:
  type: EXPLORER
  filter: '"`tags.language` = ''python''"'

install:
  version: '3'
  silent: true

  tasks:
    default:
      cmds:
        - task: install_agent

    install_agent:
      label: 'Finding Python processes and installing Python agent'
      cmds:
        - |
          PYTHON3_EXE=$(which python3)
          PYTHON_EXE=$(which python)
          PYPY3_EXE=$(which pypy3)
          PYPY_EXE=$(which pypy)
          CONDA_EXE=$(which conda)
          PYTHON=${PYTHON3_EXE:-${PYTHON_EXE:-${PYPY3_EXE:-${PYPY_EXE:-${CONDA_EXE}}}}}

          if [ -z "$PYTHON" ]; then
            echo "No Python found"
            exit 1
          fi

          $PYTHON -m pip install newrelic-introspector
          FOUND_PROCESSES=$($PYTHON -m newrelic_introspector --list)
          if [ -z "$FOUND_PROCESSES" ] ||  [ "$FOUND_PROCESSES" == "[]" ]; then
            echo "No Python processes found running on the host" >> /dev/stderr
            exit 3
          else
            PROCESSES=$(echo "$FOUND_PROCESSES" | sed -e "s/\[//" | sed -e "s/\]//")
            for PID in "${PROCESSES[@]}"
            do
              $PYTHON -m newrelic_introspector --install --pid ${PID}
              $PYTHON -m newrelic_introspector --introspect --pid ${PID}
              printf "\nEnter an app name: "
              read -r appName
              sudo -u $SUDO_USER $PYTHON -m newrelic_introspector --instrument --yes --pid ${PID} --appName "$appName" --licenseKey {{.NEW_RELIC_LICENSE_KEY}} --region STAGING
            done
          fi
