---
- debug:
    msg: Install Oracle

- name: Set default create_env_var (default not create)
  set_fact:
    create_env_var: "false"
  when: create_env_var is undefined

- name: update packages
  shell: yum update -y
  become: true

- name: install dependiences
  shell: yum install -y binutils.x86_64 compat-libcap1.x86_64 gcc.x86_64 gcc-c++.x86_64 glibc.i686 glibc.x86_64 glibc-devel.i686 glibc-devel.x86_64 ksh sudo  libaio.i686 libaio.x86_64 libaio-devel.i686 libaio-devel.x86_64 libgcc.i686 libgcc.x86_64 libstdc++.i686 libstdc++.x86_64 libstdc++-devel.i686 libstdc++-devel.x86_64 libXi.i686 libXi.x86_64 libXtst.i686 libXtst.x86_64 make.x86_64 sysstat.x86_64 zip unzip curl wget
  become: true

- name: get compat-libstdc++
  shell: wget https://www.rpmfind.net/linux/centos/7.9.2009/os/x86_64/Packages/compat-libstdc++-33-3.2.3-72.el7.x86_64.rpm -P /etc/
  become: true

- name: install compat-libstdc++
  shell: yum install -y /etc/compat-libstdc++-33-3.2.3-72.el7.x86_64.rpm 
  become: true 

- name: get oracle database preinstall 
  shell: curl -o oracle-database-preinstall-18c-1.0-1.el7.x86_64.rpm https://yum.oracle.com/repo/OracleLinux/OL7/latest/x86_64/getPackage/oracle-database-preinstall-18c-1.0-1.el7.x86_64.rpm
  become: true

- name: install oracle databsae preinstall
  shell: yum -y localinstall oracle-database-preinstall-18c-1.0-1.el7.x86_64.rpm 
  become: true

- name: get oracle database
  shell: wget https://download.oracle.com/otn-pub/otn_software/db-express/oracle-database-xe-18c-1.0-1.x86_64.rpm -P /etc/
  become: true

- name: install oracle database
  shell: yum -y localinstall /etc/oracle-database-xe-18c-1.0-1.x86_64.rpm
  become: true 

- name: update oracle file
  template:
    src: oracle-xe-18c
    dest: /etc/init.d/oracle-xe-18c
  become: true 

- name: update oracle config file
  template:
    src: oracle-xe-18c.conf
    dest: /etc/sysconfig/oracle-xe-18c.conf
  become: true 

- name: copy queries
  template:
    src: queries.sql
    dest: /etc/queries.sql
  become: true 

- name: run oracle db
  shell: echo "oracle" | echo "oracle" | /etc/init.d/oracle-xe-18c configure
  become: true 

- name: get oracle instant client
  shell: wget https://download.oracle.com/otn_software/linux/instantclient/185000/oracle-instantclient18.5-basic-18.5.0.0.0-3.x86_64.rpm -P /opt/oracle/product/18c/dbhomeXE/
  become: true

- name: install oracle insant client
  shell: yum install -y /opt/oracle/product/18c/dbhomeXE/oracle-instantclient18.5-basic-18.5.0.0.0-3.x86_64.rpm
  become: true

- name: get sqlplus
  shell: wget https://download.oracle.com/otn_software/linux/instantclient/185000/oracle-instantclient18.5-sqlplus-18.5.0.0.0-3.x86_64.rpm -P /opt/oracle/product/18c/dbhomeXE
  become: true

- name: install sqlplus
  shell: yum install -y /opt/oracle/product/18c/dbhomeXE/oracle-instantclient18.5-sqlplus-18.5.0.0.0-3.x86_64.rpm
  become: true

- name: export ORACLE_HOME variable
  shell: export ORACLE_HOME=/opt/oracle/product/18c/dbhomeXE
  become: true

- name: export ORACLE_SID variable
  shell: export ORACLE_SID=XE
  become: true

- name: fix error for sqlplus connect
  shell: LD_LIBRARY_PATH=/opt/oracle/product/18c/dbhomeXE/lib:$LD_LIBRARY_PATH | export LD_LIBRARY_PATH | cd /opt/oracle/product/18c/dbhomeXE/lib/ | ln -s /opt/oracle/product/18c/dbhomeXE/inventory/Scripts/ext/lib/libclntshcore.so.18.1 | chown oracle:oinstall libclntshcore.so.18.1
  become: true 

- name: Connect via SQLPLUS
  shell: echo oracle | sqlplus64 sys as SYSDBA < /etc/queries.sql
  become: true

- block:
  - name: Export USERNAME
    shell: "echo export NR_CLI_ORACLEDB_USERNAME=newrelic >> ~/.bashrc"
  - name: Export PASSWORD
    shell: "echo export NR_CLI_ORACLEDB_PASSWORD=Virtuoso4all! >> ~/.bashrc"
  - name: Export HOSTNAME
    shell: "echo export NR_CLI_ORACLEDB_HOST=localhost >> ~/.bashrc"
  - name: Export DB_PORT
    shell: "echo export NR_CLI_ORACLEDB_PORT=1521 >> ~/.bashrc"
  - name: Export ORACLE_HOME_PATH
    shell: "echo export NR_CLI_ORACLEDB_HOME_PATH=/opt/oracle/product/18c/dbhomeXE >> ~/.bashrc"
  - name: Export ORACLE_SERVICE_NAME
    shell: "echo export NR_CLI_ORACLEDB_SERVICE_NAME=ORCL >> ~/.bashrc"
  - name: Export ORACLE_CUSTOM_METRICS_CONFIG
    shell: "echo export NR_CLI_ORACLEDB_CUSTOM_METRICS_CONFIG=/etc/queries.sql  >> ~/.bashrc"
  - name: Export ORACLE_SYS_DBA
    shell: "echo export NR_CLI_ORACLEDB_SYS_DBA=false  >> ~/.bashrc"
  - name: Export ORACLE_SYS_OPER
    shell: "echo export NR_CLI_ORACLEDB_SYS_OPER=false  >> ~/.bashrc"
  - name: Export ORACLE_EXTENDED_METRICS
    shell: "echo export NR_CLI_ORACLEDB_EXTENDED_METRICS=false  >> ~/.bashrc"
  when: create_env_var|bool

