---
- debug:
    msg: Install OracleDb

- name: Set default create_env_var (default not create)
  set_fact:
    create_env_var: "false"
  when: create_env_var is undefined

- name: Set default create_newrelic_user (default not create)
  set_fact:
    create_newrelic_user: "false"
  when: create_newrelic_user is undefined

- name: Install alien and libaio package
  apt:
    name: ['libaio*', 'alien']
    update_cache: yes
    state: latest
  become: yes

- name: Create dir for database download
  shell: mkdir /opt/distr
  become: yes

- name: Download Oracle Database XE 18c
  get_url:
    url: https://download.oracle.com/otn-pub/otn_software/db-express/oracle-database-xe-18c-1.0-1.x86_64.rpm
    dest: /opt/distr/oracle-database-xe-18c-1.0-1.x86_64.rpm
  become: yes

- name: Convert Oracle Database XE 18c file into deb file
  shell: alien --scripts /opt/distr/oracle-database-xe-18c-1.0-1.x86_64.rpm 
  become: yes

- name: Install Oracle Database XE 18c
  shell: dpkg -i /opt/distr/oracle-database-xe-18c_1.0-2_amd64.deb
  become: yes

- block:
  - name: Export NR_CLI_SERVICE_NAME
    shell: "echo export NR_CLI_SERVICE_NAME=test >> ~/.bashrc"
  - name: Export NR_CLI_PORT
    shell: "echo export NR_CLI_PORT=1521 >> ~/.bashrc"
  - name: Export NR_CLI_USERNAME
    shell: "echo export NR_CLI_USERNAME=NewRelicUser >> ~/.bashrc"
  - name: Export NR_CLI_PASSWORD
    shell: "echo export NR_CLI_PASSWORD=Virtuoso4all! >> ~/.bashrc"
  - name: Export NR_CLI_IS_SYS_DBA
    shell: "echo export NR_CLI_IS_SYS_DBA=false >> ~/.bashrc"
  - name: Export NR_CLI_IS_SYS_OPER
    shell: "echo export NR_CLI_IS_SYS_OPER=false >> ~/.bashrc"
  - name: Export NR_CLI_HOSTNAME
    shell: "echo export NR_CLI_HOSTNAME=localhost >> ~/.bashrc"
  - name: Export NR_CLI_ORACLE_HOME
    shell: "echo export NR_CLI_ORACLE_HOME=tbd >> ~/.bashrc"
  - name: Export NR_CLI_EXTENDED_METRICS
    shell: "echo export NR_CLI_EXTENDED_METRICS=false >> ~/.bashrc"
  when: create_env_var|bool


