---
- debug:
    msg: Install HashiCorp Consul

- name: Add repo consul
  shell: zypper addrepo https://download.opensuse.org/repositories/Virtualization:containers/SLE_12_SP5/Virtualization:containers.repo
  become: true

- name: Refresh repos
  shell: zypper refresh
  become: true

- name: Install consul
  shell: zypper -n install consul
  become: true

- name: Create consul config directory
  shell: mkdir -p ~/consul-config/server

- name: Copy consul server config file
  template:
    src: config.json
    dest: ~/consul-config/server/config.json
  become: true

- name: Export NR_CLI_HOSTNAME
  shell: "echo export NR_CLI_HOSTNAME=localhost >> ~/.bashrc"

- name: Export NR_CLI_PORT
  shell: "echo export NR_CLI_PORT=8500 >> ~/.bashrc"

- name: Export NR_CLI_TOKEN
  shell: "echo export NR_CLI_TOKEN= >> ~/.bashrc"

- name: Export NR_CLI_ENABLE_SSL
  shell: "echo export NR_CLI_ENABLE_SSL=n >> ~/.bashrc"

- name: Export NR_CLI_BUNDLE_DIR
  shell: "echo export NR_CLI_CA_BUNDLE_DIR= >> ~/.bashrc"

- name: Export NR_CLI_FILE_DIR
  shell: "echo export NR_CLI_CA_BUNDLE_DIR= >> ~/.bashrc"

- name: Start the consul server
  shell: consul agent -config-dir ~/consul-config/server -client=0.0.0.0
  become: true
