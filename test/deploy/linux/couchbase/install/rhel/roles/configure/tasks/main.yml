---
- debug:
    msg: Install Couchbase

- name: update packages
  shell: yum update -y
  become: true 

- name: install couchbase
  shell: rpm --install https://packages.couchbase.com/releases/6.6.0/couchbase-server-community-6.6.0-amzn2.x86_64.rpm
  become: true 

- name: configure couchbase
  shell: /opt/couchbase/bin/couchbase-cli cluster-init --cluster localhost:8091 --cluster-name newrelic --cluster-username newrelic --cluster-password Virtuoso4all! --cluster-ramsize 1600 --cluster-analytics-ramsize 1024 --services data
  become: true 

- block:
  - name: Export NR_CLI_USERNAME
    shell: "echo export NR_CLI_USERNAME=newrelic >> ~/.bashrc"
  - name: Export NR_CLI_PASSWORD
    shell: "echo export NR_CLI_PASWORD=Virtuoso4all! >> ~/.bashrc"
  - name: Export NR_CLI_HOSTNAME
    shell: "echo export NR_CLI_HOSTNAME=localhost! >> ~/.bashrc"
  - name: Export NR_CLI_API_PORT
    shell: "echo export NR_CLI_API_PORT=8091 >> ~/.bashrc"
  - name: Export NR_CLI_QUERY_PORT
    shell: "echo export NR_CLI_QUERY_PORT=8093 >> ~/.bashrc" 
  - name: Export USE_SSL
    shell: "echo export NR_CLI_API_USE_SSL=false >> ~/.bashrc"
  - name: Export CA_BUNDLE_DIR
    shell: "echo export NR_CLI_API_CA_BUNDLE_DIR=notUsed >> ~/.bashrc"
  - name: Export CA_BUNDLE_FILE
    shell: "echo export NR_CLI_API_CA_BUNDLE_FILE=notUsed >> ~/.bashrc"
  when: create_env_var|bools
