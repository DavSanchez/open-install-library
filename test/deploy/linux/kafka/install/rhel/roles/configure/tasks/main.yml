---
- debug:
    msg: Install Kafka

- name: update packages
  shell: yum update -y  
  become: true 

- name: install java
  shell: yum install java-1.8.0-openjdk -y
  become: true 

- name: create downloads directory
  shell: mkdir ~/Downloads
  become: true

- name: download kafka
  shell: wget "https://www.apache.org/dist/kafka/2.6.1/kafka_2.13-2.6.1.tgz" -P ~/Downloads/ 
  become: true 

- name: create and change directory
  shell: mkdir ~/kafka && cd ~/kafka
  become: true 

- name: extract tgz file
  shell: tar -xzf ~/Downloads/kafka_2.13-2.6.1.tgz -C ~/kafka/
  become: true 

- name: Copy Server Properties
  template: 
      src: server.properties
      dest: ~/kafka/kafka_2.13-2.6.1/config/server.properties
  become: true

- name: Copy Zookeeper service file
  template:
      src: zookeeper.service
      dest: /etc/systemd/system/zookeeper.service
  become: true

- name: Copy Kafka service file
  template:
      src: kafka.service
      dest: /etc/systemd/system/kafka.service
  become: true

- name: restart daemon
  shell: systemctl daemon-reload
  become: true

- name: run zookeeper
  shell: systemctl start zookeeper.service
  become: true 

- name: run kafka
  shell: systemctl start kafka
  become: true

- name: test the installation
  shell: ~/kafka/kafka_2.13-2.6.1/bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic TutorialTopic
  become: true 

- name: push hello string
  shell: echo "Hello, World" | ~/kafka/kafka_2.13-2.6.1/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic TutorialTopic > /dev/null
  become: true

- name: check the output
  shell: ~/kafka/kafka_2.13-2.6.1/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic TutorialTopic --from-beginning
  become: true
