---

- name: Set default create_env_var (default not create)
  set_fact:
    create_env_var: "false"
  when: create_env_var is undefined

- name: Download MongoDB install file
  win_shell: curl https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-4.4.5-signed.msi -O mongodb-windows-x86_64-4.4.5-signed.msi
  args:
    chdir: C:\
  register: output

- fail:
    msg: "MongoDB was not downloaded on the host"
  when: output is failed

- name: install mongo msi file
  win_shell: msiexec.exe /q /i mongodb-windows-x86_64-4.4.5-signed.msi "ADDLOCAL=ALL" SHOULD_INSTALL_COMPASS="0"  | Out-Null
  args:
    chdir: C:\

- name: create db folder
  win_shell: md "data\db"
  args:
    chdir: C:\

- name: copy config file
  template:
    src: mongod.cfg
    dest: C:\Progra~1\MongoDB\Server\4.4\bin\mongod.cfg

- name: copy install script
  template:
    src: install.ps1
    dest: C:\

- name: run install command
  win_shell: .\install.ps1
  args:
    chdir: C:\

- name: restart mongodb 
  win_shell: Restart-Service MongoDB

- name: copy commands.js file
  template: 
    src: commands.js
    dest: C:\

- name: copy initiate.js file
  template: 
    src: initiate.js
    dest: C:\

- name: use initiate command file
  win_shell: .\mongo.exe C:\initiate.js
  args:
    chdir: C:\Progra~1\MongoDB\Server\4.4\bin
  register: output

- name: use commands.js file
  win_shell: .\mongo.exe C:\commands.js
  args:
    chdir: C:\Progra~1\MongoDB\Server\4.4\bin
  register: output

- name: restart mongodb
  win_shell: Restart-Service MongoDB

- block:
  - name: Export USERNAME
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_USERNAME','newrelic',[System.EnvironmentVariableTarget]::User)"
  - name: Export PASSWORD
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_PASSWORD','Virtuoso4all!',[System.EnvironmentVariableTarget]::User)"
  - name: Export CLUSTERNAME
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_CLUSTERNAME','test',[System.EnvironmentVariableTarget]::User)"
  - name: Export AUTH
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_AUTH','admin',[System.EnvironmentVariableTarget]::User)"
  - name: Export HOSTNAME
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_HOSTNAME','localhost',[System.EnvironmentVariableTarget]::User)"
  - name: Export PORT
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_PORT','27017',[System.EnvironmentVariableTarget]::User)"
  - name: Export SSL
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_SSL','n',[System.EnvironmentVariableTarget]::User)"
  - name: Export CERT AUTH FILE
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_CERT_AUTH_FILE','notUsed',[System.EnvironmentVariableTarget]::User)"
  - name: Export SKIP SSL
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_SKIP_SSL_VERIFY','y',[System.EnvironmentVariableTarget]::User)"
  - name: Export CLIENT CERT FILE
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_CLIENT_CERT_FILE','notUsed',[System.EnvironmentVariableTarget]::User)"
  - name: Export CLIENT CERT PASSPHRASE
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_CERT_PASSPHRASE','notUsed',[System.EnvironmentVariableTarget]::User)"
  - name: Export FILTERS 
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_DB_FILTERS','{"admin":null}',[System.EnvironmentVariableTarget]::User)"
  when: create_env_var|bool