---

- name: Set default create_env_var (default not create)
  set_fact:
    create_env_var: "false"
  when: create_env_var is undefined

- name: Download Redis install file
  win_shell: curl https://github.com/microsoftarchive/redis/releases/download/win-3.2.100/Redis-x64-3.2.100.msi -O Redis-x64-3.2.100.msi
  args:
    chdir: C:\
  register: output

- fail:
    msg: "Redis was not downloaded on the host"
  when: output is failed

- name: Install Redis
  win_shell: msiexec /i Redis-x64-3.2.100.msi /qn
  args:
    chdir: C:\

- fail:
    msg: "SqlServer is not installed on the host"
  when: output is failed

- name: Copy config file
  template:
    src: redis.windows-service.conf
    dest: C:\Progra~1\Redis\redis.windows-service.conf

- name: Ensure that port 6379 is free
  win_shell: Stop-Process -Id (Get-NetTCPConnection -LocalPort 6379).OwningProcess -Force

- name: Install Redis as service
  win_shell: .\redis-server.exe redis.windows-service.conf --service-install
  args:
    chdir: C:\Progra~1\Redis\
  ignore_errors: yes

- name: Run Redis as service
  win_shell: .\redis-server.exe --service-run
  args:
    chdir: C:\Progra~1\Redis\

- block:
  - name: Export KEYS
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_KEYS','None',[System.EnvironmentVariableTarget]::User)"
  - name: Export PASSWORD
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_PASSWORD','Virtuoso4all!',[System.EnvironmentVariableTarget]::User)"
  - name: Export HOSTNAME
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_HOSTNAME','localhost',[System.EnvironmentVariableTarget]::User)"
  - name: Export PORT
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_PORT','6379',[System.EnvironmentVariableTarget]::User)"
  when: create_env_var|bool
