---

- name: Set default create_env_var (default not create)
  set_fact:
    create_env_var: "false"
  when: create_env_var is undefined

- name: Download Redis install file
  win_shell: curl https://github.com/microsoftarchive/redis/releases/download/win-3.2.100/Redis-x64-3.2.100.msi -O Redis-x64-3.2.100.msi
  args:
    chdir: C:\
  register: output

- fail:
    msg: "Redis was not downloaded on the host"
  when: output is failed

- name: Install Redis
  win_shell: msiexec /i Redis-x64-3.2.100.msi /qn
  args:
    chdir: C:\

- fail:
    msg: "SqlServer is not installed on the host"
  when: output is failed

- name: Copy config file
  template:
    src: redis.windows.conf
    dest: C:\Progra~1\Redis\redis.windows.conf

- name: Run Redis service
  win_shell: .\redis-server.exe redis.windows.conf
  args:
    chdir: C:\Progra~1\Redis\

- block:
  - name: Export USERNAME
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_KEYS','None',[System.EnvironmentVariableTarget]::User)"
  - name: Export PASSWORD
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_PASSWORD','Virtuoso4all',[System.EnvironmentVariableTarget]::User)"
  - name: Export HOSTNAME
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_HOSTNAME','127.0.0.1',[System.EnvironmentVariableTarget]::User)"
  - name: Export NR_CLI_DB_PORT
    win_shell: "[System.Environment]::SetEnvironmentVariable('NR_CLI_PORT','6379',[System.EnvironmentVariableTarget]::User)"
  when: create_env_var|bool
